<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ผลการคำนวณปริมาณยา - Medical Dosage System</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=K2D:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "K2D", sans-serif;
      background-color: #CBEAEB; 
    }
    
    header {
      background: linear-gradient(135deg, #39AC95 100%, #2E8B7A 0%);
      display: flex;
      align-items: center;
      padding: 15px 30px;
      position: relative;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    .logo-container {
      position: relative;
      width: fit-content;
      margin: 50px 0 0 20px;
      text-align: start;
    }

    .pills-background {
      width: 210px;
      opacity: 0.9;
      margin-top: -60px;
      transform: translateX(-25px);
    }
    
    nav {
      margin-left: auto;
      display: flex;
      gap: 30px;
    }
    
    nav a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      font-size: 20px;
      transition: all 0.3s;
      padding: 8px 16px;
      border-radius: 8px;
      position: relative;
    }
    
    nav a:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .main-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }

    .result-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .result-title {
      font-size: 28px;
      font-weight: bold;
      color: #2c3e50;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .success-icon {
      background: #27ae60;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .patient-medicine-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      border-left: 5px solid #39AC95;
    }

    .section-title {
      font-size: 16px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-item {
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }

    .medicine-title {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 10px;
      text-align: center;
    }

    .dosage-calculation {
      text-align: center;
      margin: 45px 0
    }

    .calculation-title {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 20px;
    }

    .dosage-boxes {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    .dosage-box {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .dosage-value {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #eaeaea;
    }

    .dosage-label {
      font-size: 12px;
      opacity: 0.9;
      color: #FDD835;
    }

    .success-alert {
      background: linear-gradient(135deg, #f0d2d2,#f0d2d2);
      border-radius: 10px;
      padding: 15px 20px;
      text-align: center;
      margin: 20px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .success-alert .check-icon {
      background: #27ae60;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .success-text {
      font-weight: bold;
      color: #333;
    }

    .success-subtext {
      font-size: 12px;
      color: #666;
      display: block;
      margin-top: 3px;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 25px;
      font-family: "K2D", sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-dark {
      background: #2c3e50;
      color: white;
    }

    .btn-dark:hover {
      background: #34495e;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: #2c3e50;
      color: white;
    }

    .btn-secondary:hover {
      background: #34495e;
      transform: translateY(-2px);
    }

    @media (max-width: 768px) {
      .patient-medicine-info {
        grid-template-columns: 1fr;
      }
      
      .dosage-boxes {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="logo-container">
    <img src="logopj.png" alt="Pills" class="pills-background">
  </div>
  <nav>
    <a href="homepage.html">หน้าหลัก</a>
    <a href="managepatientdata.html">จัดการข้อมูลผู้ป่วย</a>
    <a href="medicine.html">ข้อมูลยา</a>
    <a href="calculatemed.html">คำนวณปริมาณยา</a>
    <a href="history.html">ประวัติการคำนวณยา</a>
  </nav>
</header>

<div class="main-container">
  <div class="result-header">
    <div class="result-title">
      <div class="success-icon">
        <i class="fa fa-check"></i>
      </div>
      ผลการคำนวณปริมาณยา
    </div>
  </div>
    <div class="patient-medicine-info">
      <div class="info-section">
        <div class="section-title">
          <i class="fa fa-user"></i>
          ผู้ป่วย: <span id="patientDisplayName"></span>
        </div>
        <div class="info-item">อายุ: <span id="patientAge"></span></div>
        <div class="info-item">น้ำหนัก: <span id="patientWeight"></span></div>
      </div>

      <div class="info-section">
        <div class="section-title">
          <i class="fa fa-medkit"></i>
          ยา: <span id="medicineDisplayName"></span>
        </div>
        <div class="info-item">ประเภท: <span id="medicineType"></span></div>
        <div class="info-item">ความถี่: <span id="medicineFreq"></span></div>
      </div>
    </div>

    <div class="dosage-calculation">
      <div class="calculation-title">ปริมาณยา</div>
      
      <div class="dosage-boxes">
        <div class="dosage-box">
          <div class="dosage-value" id="dosePerTime">XX.XX</div>
          <div class="dosage-label">มก.ต่อครั้ง</div>
        </div>
        <div class="dosage-box">
          <div class="dosage-value" id="dailyDoses">XX.XX</div>
          <div class="dosage-label">มก./วัน</div>
        </div>
        <div class="dosage-box">
          <div class="dosage-value" id="totalMonthlyDose">XX.XX</div>
          <div class="dosage-label">มก./เดือน</div>
        </div>
      </div>
    </div>

    <div class="success-alert">
      <div class="check-icon">
        <i class="fa fa-check"></i>
      </div>
      <div>
        <div class="success-text">การคำนวณสำเร็จ !</div>
        <span class="success-subtext">ผลลัพธ์ได้ถูกบันทึกในประวัติแล้ว</span>
      </div>
    </div>

    <div class="action-buttons">
      <a href="calculatemed.html" class="btn btn-dark">คำนวณใหม่</a>
      <a href="history.html" class="btn btn-secondary">ดูประวัติการคำนวณ</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  loadCalculationResult();
});

function loadCalculationResult() {
  let latestCalculation = localStorage.getItem('latestCalculation');
  let data;

  if (latestCalculation) {
    try {
      data = JSON.parse(latestCalculation);
      console.log('ข้อมูลที่ได้รับ:', data);

      if (!data.timestamp || isNaN(Date.parse(data.timestamp))) {
        console.warn('Invalid timestamp detected, resetting to current time');
        data.timestamp = new Date().toISOString();
      }

    } catch (error) {
      console.error('Error parsing latestCalculation:', error);
      data = null;
    }
  }

  if (!data) {
    data = {
      patient: { name: 'ไม่มีข้อมูลผู้ป่วย', age: '-', weight: '-' },
      medicine: { name: 'ไม่มีข้อมูลยา', type: '-', frequency: '-' },
      dosageResult: { dosePerTime: 'XX.XX', totalDailyDose: 'XX.XX', dailyDoses: 'XX.XX' },
      timestamp: new Date().toISOString()
    };
  }
  
  displayCalculationResult(data);
  
  if (data.patient && data.patient.name !== 'ไม่มีข้อมูลผู้ป่วย') {
    saveToHistory(data);
  }
}

function displayCalculationResult(data) {
  console.log('แสดงข้อมูล:', data);

  if (data.patient) {
    document.getElementById('patientDisplayName').textContent = data.patient.name || '-';
    document.getElementById('patientAge').textContent = data.patient.age ? `${data.patient.age} ปี` : '-';
    document.getElementById('patientWeight').textContent = data.patient.weight ? `${data.patient.weight} กิโลกรัม` : '-';
  } else {
    document.getElementById('patientDisplayName').textContent = '-';
    document.getElementById('patientAge').textContent = '-';
    document.getElementById('patientWeight').textContent = '-';
  }

  if (data.medicine) {
    document.getElementById('medicineDisplayName').textContent = data.medicine.name || 'ไม่ระบุ';
    document.getElementById('medicineType').textContent = data.medicine.type || 'ไม่ระบุ';
    document.getElementById('medicineFreq').textContent = data.medicine.frequency || 'ไม่ระบุ';
  } else {
    document.getElementById('medicineDisplayName').textContent = 'ไม่มีข้อมูลยา';
    document.getElementById('medicineType').textContent = '-';
    document.getElementById('medicineFreq').textContent = '-';
  }

  // แสดงผลการคำนวณ
  if (data.dosageResult) {
    document.getElementById('dosePerTime').textContent = data.dosageResult.dosePerTime || 'XX.XX';
    document.getElementById('dailyDoses').textContent = data.dosageResult.totalDailyDose || 'XX.XX';
    
    // คำนวณปริมาณต่อเดือน (30 วัน)
    const dailyDose = parseFloat(data.dosageResult.totalDailyDose) || 0;
    const monthlyDose = (dailyDose * 30).toFixed(2);
    document.getElementById('totalMonthlyDose').textContent = monthlyDose;
  } else {
    document.getElementById('dosePerTime').textContent = 'XX.XX';
    document.getElementById('dailyDoses').textContent = 'XX.XX';
    document.getElementById('totalMonthlyDose').textContent = 'XX.XX';
  }
}

function saveToHistory(data) {
  if (!data || !data.patient || !data.medicine) {
    console.log('No valid data to save to history');
    return;
  }

  const record = {
    patient: {
      name: data.patient.name || 'ไม่ระบุ',
      age: data.patient.age || '',
      weight: data.patient.weight || ''
    },
    medicine: {
      name: data.medicine.name || 'ไม่ระบุ',
      type: data.medicine.type || '',
      frequency: data.medicine.frequency || ''
    },
    dosageResult: {
      dosePerTime: data.dosageResult?.dosePerTime || '',
      totalDailyDose: data.dosageResult?.totalDailyDose || '',
      dailyDoses: data.dosageResult?.dailyDoses || ''
    },
    timestamp: data.timestamp || new Date().toISOString()
  };

  let history = [];
  try {
    const existingHistory = localStorage.getItem("calculationHistory");
    if (existingHistory) {
      history = JSON.parse(existingHistory);
    }
  } catch (error) {
    console.error('Error parsing existing history:', error);
    history = [];
  }

  const isDuplicate = history.some(existingRecord => {
    return existingRecord.patient?.name === record.patient.name &&
           existingRecord.medicine?.name === record.medicine.name &&
           Math.abs(new Date(existingRecord.timestamp).getTime() - new Date(record.timestamp).getTime()) < 5000; 
  });

  if (!isDuplicate) {
    history.push(record);
    
    try {
      localStorage.setItem("calculationHistory", JSON.stringify(history));
      console.log('Successfully saved to history:', record);
    } catch (error) {
      console.error('Error saving to history:', error);
    }
  } else {
    console.log('Duplicate record detected, not saving to history');
  }
}
</script>
</body>
</html>